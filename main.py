import random
import math
import Enemy
import pygame
import pygame.freetype
import Particle
import Wall
import Player
import time

def load_room(rx, ry): #ritar alla kvadrater enligt rum-listorna
    Wall.walls = []
    x = y = 0
    for row in rooms[rx + 5 * ry]:
        for col in row:
            if col == "5":
                Wall.Wall((x, y), "wall")
            if col == "6":
                Wall.Wall((x, y), "solid_front_wall", )
            if col == "7":
                Wall.Wall((x, y), "front_wall", )
            if col == "4":
                Wall.Wall((x, y), "back_wall", )
            if col == "3":
                Wall.Wall((x, y), "back_wall_2", )
            if col == "2":
                Wall.Wall((x, y), "back_wall_3", )
            if col == "n":
                load_enemy("normal", x, y)
            if col == "l":
                load_enemy("large", x, y)
            if col == "f":
                load_enemy("flying", x, y)
            if col == "r":
                load_enemy("ranged", x, y)
            if col == "b":
                load_enemy("boss", x, y)
            x += 16
        y += 16
        x = 0

def load_enemy(type, pos_x, pos_y):
    Enemy.Enemy(type, pos_x, pos_y, len(Enemy.enemies))

pygame.init()


#variabler
screen = pygame.display.set_mode((1280, 660))
clock = pygame.time.Clock()
running = True
dt = 0
rx = 2
ry = 4
grounded = False
grounded1 = False
crouchval = False
shot_timer = 0
screen = pygame.display.set_mode((screen.get_width(), screen.get_height()))
player = Player.Player()
player_mom_vert = 0
rand = random.Random()
mouse_ang = 0
cursor_pos = (0, 0)
rect = pygame.Rect(50, 50, 0, 20)
saved_pos_1 = pygame.Vector2(0, 0)
color_var = 0
weapon_mode = "normal"
switch_timer = 0
crouch_timer = 0
help_timer = 300
weapon_color = (120, 120, 120)
dead = False
game_text = pygame.freetype.SysFont(None, 24)


help_texts = ["A/D - Movement", "W - Jump", "S - Toggle crouch", "R - Switch weapon", "F - Fire weapon"]



#alla rum
roomTEST = [
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"55555                                                                      55555",
"5555555555                 55555   55555   55555   55555   55555           55555",
"5555555555                 5   5   5   5   5   5   5   5   5   5           55555",
"5555555555                 5 n 5   5 l 5   5 f 5   5 r 5   5 b 5           55555",
"5555555555                 5   5   5   5   5   5   5   5   5   5           55555",
"5555555555                 55555   55555   55555   55555   55555           55555",
"55555                                                                      55555",
"55555                                                                      55555",
"555555555555555                                                            55555",
"555555555555555                                                            55555",
"555555555555555                                                            55555",
"555555555555555                                                            55555",
"555555555555555                                                            55555",
"555555555555555                                                            55555",
"55555                                                                      55555",
"55555                                                                      55555",
"555555555555555555555                                                      55555",
"555555555555555555555                                                      55555",
"555555555555555555555                                                      55555",
"55555      5555555555                                                      55555",
"55555      5555555555                                                      55555",
"55555      5555555555                                                      55555",
"55555      5555555555                                                      55555",
"55555      5555555555                                                      55555",
"55555                                    5555                              55555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555"
]

room30 = [
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"5555555555555555555                                                              ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555                                                            ",
"55555555555555555555 r                                                          ",
"55555555555555555555555                                                         ",
"5555555555555555555555                                                          ",
"555555555555555555555                                                           ",
"555555555555555555555                                                           ",
"5555555555555555555555                                                          ",
"5555555555555555555555                                                         4",
"5555555555555555555555                                                         4",
"5555555555555555555555 r                                                      4 ",
"5555555555555555555555555                                                     4 ",
"555555555555555555555555                                                      4 ",
"55555555555555555555555                                                      4  ",
"55555555555555555555555                                                      4  ",
"55555555555555555555555                                   5555555555555555555555",
"55555555555555555555555                                           555555555555  ",
"55555555555555555555555                                    555555555555555555555",
"55555555555555555555555                                                         ",
"55555555555555555555555                                                         "
]

room31 = [
"      4                                                                   7     ",
"      4                                                                   7     ",
"     4                                                                    7     ",
"     4                                                                    7     ",
"     4                                                                    7     ",
"     4                                                                   7      ",
"      4                                                                  7      ",
"      4                                                                  7      ",
"      4                                                                  7      ",
"      4                                                                  7      ",
"      4                                                                   7     ",
"      4                                                                   7     ",
"      4                                                                   7     ",
"      4                                                                   7     ",
"     4 4                                                                  7     ",
"     4 4                                                                 7      ",
"    4  4                                                                 7      ",
"    4   4                                                                7      ",
"    4   4                         f                                      7      ",
"   4    4                                                                7      ",
"   4     4                                                                7     ",
"  4       4                                               f               7     ",
"  4       4      f                                                        7     ",
" 4         4                                                              7     ",
" 4         4                                                              7     ",
"4           4                                                            7      ",
"4           4                                                            7      ",
"4            4                                                           7      ",
"             4                                                            7     ",
"              4                                                           7     ",
"              4                                                           7     ",
"               4                                                          7     ",
"                4                                                          7    ",
"                 4                                                        7     ",
"                  4                                                       7     ",
"                   44         r                    r                     66     ",
"555555555555555555555555555555555                 555555555555555555555565555555",
"             5555555                               5555           5555556554  55",
"555555555555555555555555555555                5555555555555555555555555565555555",
"                                                                         66     ",
"                                                                                "
]

room32 = [
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                        666                     ",
"                                                        666                     ",
"                                                        66                      ",
"                                                        666                     ",
"                                                       4444                     ",
"                                                        44                      ",
"                                                        44                      ",
"                                                        444                     ",
"                                                       6666                     ",
"                            66                         6666                     ",
"                         66666                  6      6666                     ",
"555                      66666     6       b    6      6666     666             ",
"55               555555555555555555555555555555555555555555555555555            ",
"555            555555555555555555555555555555555555555555555555555555           ",
"                333333333333333333444444444444444443333333333333                ",
"                   222333333333333333333333333333333333332222                   "
]

room33 = [
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                "
]

room34 = [
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                ",
"                                                                                "
]

room40 = [
"55555555555555555555555                                                         ",
"55555555555555555555555                   55                           222222222",
"55555555555555555555555                  5             4     566666   2222222222",
"555555555555555555555555555          4555             454555555            22222",
"5555555555555555555555555555555555554555555555555555555545                   222",
"555555555555555555555555555555555555455555555555       4  4444               222",
"5555555555555555555555555            44         44     4      44               2",
"55555555555555555555555            444444               4       3333            ",
"55555555555555555555555           4      4444444        4                       ",
"55555555555555555555555           4 3           4444444444                      ",
"55555555555555555555555           4  3333 3333            44                    ",
"55555555555555555555555          4    3   3      333  3     4                   ",
"55555555555555555555555          4    3   333   3   3  333  4                   ",
"55555555555555555555555          4    3   3      33    3  34                    ",
"55555555555555555555555         4     3   333  3   3  3    4                    ",
"55555555555555555555555          44444          333  3     4                    ",
"55555555555555555555555               4444444             4                     ",
"55555555555555555555555                      4444444444   4                     ",
"555555555555555555555555                               444                      ",
"555555555555555555555555                                                        ",
"555555555555555555555555      4                                                 ",
"555555555555555555555555       4 4                                              ",
"5555555555555555555555555    33 44                                              ",
"55555555555555555555555555533  444                                              ",
"555555555555555555555555555555                                                  ",
"5555555555555555555555555555555555       555                                    ",
"5555555555555555555555555555555555       5555555                                ",
"55555555555555555555555555555555555       5555555                               ",
"55555555555555555555555555555555555      55555555555                            ",
"555555555555555555555555555555555555   5555555555555555                         ",
"555555555555555555555555555555555555    555555555555555555                      ",
"555555555555555555555555555555555555      5555555555555555555                   ",
"5555555555555555555555555555555555555     5555555555555555555                   ",
"5555555555555555555555555555555555555     555555555555555555555                 ",
"555555555555555555555555555555555555     5555555555555555555555555              ",
"55555555555555555555555555555555555    55555555555555555555555555555555555555555",
"55555555555555555555555555555555555    55555555555555555555555555555555555555555",
"55555555555555555555555555555555555   555555555555555555555555555555555555555555",
"55555555555555555555555555555555555   555555555555555555555555555555555555555555",
"55555555555555555555555555555555555  5555555555555555555555555555555555555555555",
"55555555555555555555555555555555555  5555555555555555555555555555555555555555555"
]

room41 = [
"                                                                                ",
"222222222222                                                22222222222222222222",
"22222222222222222222222                                    222222222222222222222",
"22222222222222222222222222222222222                   22222222222222222222222222",
"2222222222222222222222222222222            44     222222222222222222222222222222",
"22222222222222222222222222222222222222222  4442222222222222222222222222222222222",
"22222222222222222222222222222222222    22224442222222222222222222222222222222222",
"2222222222222222222222                    5544         222222222222222222222222 ",
" 222222222222222                           4444              22222222222222222  ",
"   2222222222                             444444               22222222222222   ",
"    222222222                             444444               22222222222222   ",
"    222222222                             444444               22222222222222   ",
"     22222222                             444444               22222222222222   ",
"     22222222                             444444               22222222222222   ",
"     22222222                             444444                2222222222222   ",
"     22222222                             444444                2222222222222   ",
"     22222222                            4444444                 222222222222   ",
"     22222222                            44444555                222222222222   ",
"     22222222                            4444444                 222222222222   ",
"     22222222             3              4444444                2222222222222   ",
"     222222              33              4444444               22222222222222   ",
"     22222222            33              4444444               22222222222222   ",
"     22222222           3333             4444444               22222222222222   ",
"     22222222           3333       l     4444444               22222222222222   ",
"     22222222           333      55555   4444444               22222222222222   ",
"     22222222           333    55555555554444444               22222222222222   ",
"     22222222           333   555555555555554444               22222222222222   ",
"     22222222           333   555555555555555444               22222222222222   ",
"     22222222           333  5555555555555555444               22222222222222   ",
"     22222222        444433555555555555555555444               22222222222222   ",
"     22222222     4444444455555555555555555555444              22222222222222   ",
"     22222222 44444444444555555555555555555555544              22222222222222   ",
"    222222224444444444444555555555555555555555554              22222222222222   ",
"    222222244444444444455555555555555555555555555              22222222222222   ",
"   2222244444444444555555555555555555555555555555              22222222222222   ",
"555555555555555555555555555555555555555555555555555            22222222222222   ",
"55555555555555555555555555555555555555555555555555555555555555 22222222222222   ",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555"
]

room42 = [
"               22222333333333333333333333333333333333333333333322222            ",
"2222222222222          2222222222222222222222222222222222222                    ",
"2222222                                                                         ",
"22                                                                              ",
"22222                                                                           ",
"22    6666666       2                                                           ",
"2     77777764      2                                                           ",
"      777777643    2   2                                                        ",
"      77777764333  2 22                2  2                                     ",
"      777777643333222                 2  22                                     ",
"      77777764333322222      222      2 2 2                                     ",
"      777777643333222222    222222    22  2                                     ",
"      777777666333222222    2222222   2  2                                      ",
"      7777776644332222222   2222222  22 22                                      ",
"      7777776443332222222  222222222 2 2 2                                      ",
"      7777776433332222222  22222222222  2                                       ",
"      7777776433332222222  222222222222 2                                       ",
"      77777764333322222222 22222222222222                                       ",
"      77777764333322222222 22222222222222                  222         2        ",
"      77777764333322222222 22222222222222                22222222222222222222222",
"      77777766643322222222 222222222222222               22222222222222222222222",
"      77777766433322222222 222222222222552               22222222222222222222222",
"      77777764333322222222 2225522222242224              22222222222222222222222",
"      77777764333322222222 2222242222424442              22222222222222222222222",
"      7777776433332222222222222224224242222              22222222222222222222222",
"      7777776433332222222222222224224422222              22222222224444422222222",
"  2   77777764333322222222222222242242222222             24444222224666662222222",
"   2 277777764443322222222222222224242222222             55524442224777772222222",
"   22 77777776633322222222222222222422222222 4444444    777222244444777772222222",
"    2 77777776333322222222222554222422222222 6666666    774444444444777774444442",
"    2 7777777433332222222222222244242222222227777777  47744444444444777774444444",
"     27777777433332222222222222222422222222227777777 447744444444444777774444444",
"     277777774333322222222222222224244222222277777774447774444444444777774444444",
"     277777774333322222222222222224422222222277777774444777444444444777774444444",
"      77777774333322222222222222242222222244477777774444777444444444777774444444",
"44444477777774333322222222222222242222224444477777774444774444444444777774444444",
"44444477777774444422222222222222444444555544477777774444777444444444777774444444",
"55555566666674444444444444455555555555555555566666665555567744444445666665555555",
"55555566666665555544444555555555555555555555566666665555555655555555666665555555",
"55555566666665555555555555555555555555555555566666665555556655555555666665555555",
"55555566666665555555555555555555555555555555566666665555566555555555666665555555"
]

room43 = [
"                                        33              22                    66",
"                                        33               222                666 ",
"                                        33                22               66   ",
"                                       33                  22             66    ",
"              2222222222222            33                   22           66     ",
"              222   2222222            33                    22         66      ",
"              222   2222222            33                     222     666       ",
"              222   2222222            33                     2 222  66 6       ",
"              2222222222222           33                          6666          ",
"              2222222222222           33                        666 22          ",
"              2222222222222           33                       66    222        ",
"              2222222222222       f   33               f      55       22       ",
"              22222222   22           33                     555        22      ",
"              22222222   22          33                     55 5         22     ",
"       f      22222222   22          33                   555             222   ",
"              22222222   22          33                  555              2 222 ",
"              22222222   22          33                555                    22",
"              2222222222222          33               55 5                      ",
"              2222222222222         43               55  5                      ",
"              2222222222222         43              55                          ",
"              2222222222222         44             55                           ",
"              2222222222222         44           555                            ",
"              2222222222222         44          55 5                            ",
"              2222222222222        44          55                               ",
"              2222222222222        44         55                                ",
"              2222222222222        44        54                                 ",
"    444444    2222222222222        44       44                                  ",
"   6666664    2222222222222        44      44                                   ",
"   7777774    2222222222222       44      444                                   ",
"   7777774    222  22222222       44     44                                     ",
"   7777774    222  22222222       44    44                                      ",
"   7777774    222  22222222      44    444                                      ",
"   7777774    2222222222222      44   44 4                           55555555555",
"   7777774    2222222222222      44  44                  55555555555555555555555",
"   7777774    2222222222222     44 444           5555555555555555555555555555555",
"   7777774    2222222222222     44444   n n  55555555555555555555555555555555555",
"   7777774    222222222225555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555"
]

room44 = [
"5         33                                                         55555555555",
"          33                                                         55555555555",
"          33                                                            55555555",
"          33                                         555444444455555555555555555",
"           33                                         4 4              W55555555",
"           33                                         4  4             W55555555",
"           33                                         4   4            W55555555",
"            33                                        4    5            55555555",
"            33                                        4     4           55555555",
"             33                                       4      4          55555555",
"              33                                      4  r    4         55555555",
"              33                                     555555555544444455555555555",
"              33       f                                            4   55555555",
"              33                                                   4    55555555",
"               33                                                 4     55555555",
"               33                                                5      55555555",
"2               33                                              4       55555555",
"222             33                       f                      4       55555555",
" 22             33                                                      55555555",
"  222            32                                              555555555555555",
"    22           22                                                    555555555",
"     22          22                                                    555555555",
"      22          22                                           554    5555555555",
"      222         22                                         544    555555555555",
"        222       22                                  4   554   5555555555555555",
"          22      22                                  4  544  555555555555555555",
"           22     22                                  4 545555555555555555555555",
"            222    22                                 55555555555555555555555555",
"              222  22                      5555555555555555555555555555555555555",
"                 2222                  55555555555555555555555555555555555555555",
"                    255555555555555555555555555555555555555555555555555555555555",
"        555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555",
"55555555555555555555555555555555555555555555555555555555555555555555555555555555"
]


#rummen i ett koordinatsystem
rooms = ["room00", "room01", "room02", "room03", "room04",
         "room10", "room11", "room12", "room13", "room14",
         "room20", "room21", "room22", "room23", "room24",
         room30, room31, room32, room33, room34,
         room40, room41, room42, room43, room44,
         roomTEST]

load_room(rx, ry)

while running:
    #töm skärmen
    screen.fill("black")

    #byt rum vid kanter och ladda rum samt ta bort saker
    if player.rect.x < 10:
        player.rect.x = 1260
        rx -= 1
        Particle.particles = []
        Particle.part_trail = []
        Particle.enemy_bul = []
        Enemy.enemies = []
        load_room(rx, ry)
    if player.rect.x > 1270:
        player.rect.x = 20
        rx += 1
        Particle.particles = []
        Particle.part_trail = []
        Enemy.enemies = []
        Particle.enemy_bul = []
        load_room(rx, ry)
    if player.rect.y < 10:
        player.rect.y = 640
        ry -= 1
        Particle.particles = []
        Particle.part_trail = []
        Particle.enemy_bul = []
        Enemy.enemies = []
        load_room(rx, ry)
    if player.rect.y > 650:
        player.rect.y = 20
        ry += 1
        Particle.particles = []
        Particle.part_trail = []
        Particle.enemy_bul = []
        Enemy.enemies = []
        load_room(rx, ry)


    #första check för att man står stilla på marken,
    #för att ens momentum inte ska sparas tills när man går av en kant igen


    #lämna spel
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    #hitta vinkel till musen från spelaren
    cursor_pos = pygame.Vector2(pygame.mouse.get_pos())
    if (cursor_pos.x - (player.player_pos_x() + 8)) != 0:

        mouse_ang = -(math.atan((cursor_pos.y - (player.player_pos_y() + 16)) / (cursor_pos.x - (player.player_pos_x() + 8))) + math.pi / 2)
        if (cursor_pos.x - player.player_pos_x()) > 0:
            #här finns ett problem då man skjutar rakt upp och rakt ner, och då åker skottet åt andra hållet
            mouse_ang = (math.atan(((player.player_pos_y() + 16) - cursor_pos.y) / (cursor_pos.x - (player.player_pos_x() + 8))) + math.pi / 2)



    #gravitation och luftmotstånd
    player.move(0, player_mom_vert, True)
    player_mom_vert *= 0.98 #luftmotstånd
    player_mom_vert += 0.7 #gravitation
    if player.move_single_axis(0, player_mom_vert):
        player_mom_vert = 3

    #gravitation för fiender
    for enem in Enemy.enemies:
        if enem.type != "flying":
            enem.move(0, enem.mom_v)
            enem.mom_v *= 0.98
            enem.mom_v += 0.7
            if enem.move_single_axis(0, enem.mom_v):
                enem.mom_v = 3
        enem.track(player.player_pos_x(), player.player_pos_y())





    #timer för att skjuta
    shot_timer -= 1

    #kontroller
    keys = pygame.key.get_pressed()

    #krypläge
    if keys[pygame.K_s] and not crouchval and crouch_timer <= 0:
        player.rect = pygame.rect.Rect(player.player_pos_x(), player.player_pos_y(), 16, 16)
        crouchval = True
        crouch_timer = 10

    if keys[pygame.K_s] and crouchval and crouch_timer <= 0:
        player.rect.y -= 16
        player.rect = pygame.rect.Rect(player.player_pos_x(), player.player_pos_y(), 16, 32)
        crouchval = False
        if player.collide(): #kolla efter hinder ovanför
            player.rect.y += 16
            player.rect = pygame.rect.Rect(player.player_pos_x(), player.player_pos_y(), 16, 16)
            crouchval = True
        crouch_timer = 10




    #skjut mot muspekaren
    if keys[pygame.K_f]:
        if weapon_mode == "normal":
            if shot_timer < 0:
                Particle.Particle(player.player_pos_x() + 8, player.player_pos_y() + 16, mouse_ang, "bullet", 50, len(Particle.particles))
                shot_timer = 60
        if weapon_mode == "blast":
            if shot_timer < 0:
                for n in range(5):
                    Particle.Particle(player.player_pos_x() + 8, player.player_pos_y() + 16, mouse_ang - (math.pi / 16) + n * (math.pi / 32) + rand.randint(-1, 1) / 10, "blast", 15, len(Particle.particles))
                shot_timer = 120

    #byt vapen
    if keys[pygame.K_r]:
        if switch_timer < 0:
            if weapon_mode == "normal":
                weapon_mode = "blast"
            else:
                if weapon_mode == "blast":
                    weapon_mode = "normal"
            switch_timer = 10


    if keys[pygame.K_a]:
        if crouchval == False:
            player.move(-10, 0, True)
        else:
            player.move(-3, 0, True)

    if keys[pygame.K_d]:
        if crouchval == False:
            player.move(10, 0, True)
        else:
            player.move(3, 0, True)
    #hoppa
    if keys[pygame.K_w] and (player.move_single_axis(0, player_mom_vert) == True):
        player_mom_vert = -10


    for enem in Enemy.enemies:
        if enem.type == "ranged":
            if enem.reload <= 0:
                enem.shoot()
                enem.reload = 50
            enem.reload -= 1



    #väggar, placeras i den ordning som de är skrivna här, med plats emellan för bland annat sprajter
    for wall in Wall.walls:
        if wall.type == "back_wall_3":
            pygame.draw.rect(screen, wall.color, wall.rect)

    for wall in Wall.walls:
        if wall.type == "back_wall_2":
            pygame.draw.rect(screen, wall.color, wall.rect)

    for wall in Wall.walls:
        if wall.type == "back_wall":
            pygame.draw.rect(screen, wall.color, wall.rect)

    #spelaren
    pygame.draw.rect(screen, (255, 255, 255), player.rect)

    #fiender
    for enem in Enemy.enemies:
        pygame.draw.rect(screen, enem.color, enem.rect)

    #skott
    for part in Particle.particles:

        #kollisionsytor för skott
        if part.type == "bullet":
            Particle.Particle.move(part, 10, Particle.Particle.reval(part, "ang"), True)
            for enem in Enemy.enemies:
                enem.move(0, 0)
            Particle.Particle.move(part, 10, Particle.Particle.reval(part, "ang"), False)
            for enem in Enemy.enemies:
                enem.move(0, 0)
            Particle.Particle.move(part, 10, Particle.Particle.reval(part, "ang"), False)
            pygame.draw.circle(screen, (255, 255, 255), (part.rect.x, part.rect.y), 4)
        if part.type == "blast":
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), True)
            for enem in Enemy.enemies:
                enem.move(0, 0)
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), False)
            for enem in Enemy.enemies:
                enem.move(0, 0)
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), False)
            pygame.draw.circle(screen, (255, 0, 0), (part.rect.x, part.rect.y), 0 + part.decay / 3)


        #detaljer för skott, som rök
        if Particle.Particle.reval(part, "type") == "bullet":
            Particle.Particle(part.rect.x, part.rect.y, mouse_ang, "trail", 500, len(Particle.particles))
            for n in range(5):
                end_pos_bul_1 = pygame.Vector2(part.rect.x + rand.randint(-5, 5) * 2, part.rect.y + rand.randint(-5, 5) * 2)
                end_pos_bul_2 = pygame.Vector2(end_pos_bul_1.x + rand.randint(-5, 5) * 2, end_pos_bul_1.y + rand.randint(-5, 5) * 2)
                pygame.draw.line(screen, (255, 255, 0), (part.rect.x, part.rect.y), end_pos_bul_1, 2)
                pygame.draw.line(screen, (255, 255, 0), end_pos_bul_1, end_pos_bul_2, 1)

        if Particle.Particle.reval(part, "type") == "blast":
            for n in range(1):
                pygame.draw.line(screen, (255, 0, 0), (part.rect.x, part.rect.y), part.reval("prepos"), 0 + int(float(part.decay) / 3))

    for part in Particle.enemy_bul:
        if part.type == "danger":
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), True)
            for player in Player.players:
                player.move(0, 0, False)
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), False)
            for player in Player.players:
                player.move(0, 0, False)
            Particle.Particle.move(part, 5, Particle.Particle.reval(part, "ang"), False)
            pygame.draw.circle(screen, (255, 0, 0), (part.rect.x, part.rect.y), 6)

    #färg för rök, beroende på decay
    for part in Particle.part_trail:
        pygame.draw.circle(screen, (255, 255, 0), (part.rect.x, part.rect.y), 0)
        if saved_pos_1 != (0, 0) and not (math.sqrt(math.pow(saved_pos_1.x - part.rect.x, 2) + math.pow(saved_pos_1.y - part.rect.y, 2))) > 100:
            if not Particle.Particle.reval(part, "decay") < 0:
                trail_var = Particle.Particle.reval(part, "decay") - 200

            else:
                trail_var = 0
            color_r = 255 - math.pow((300 - trail_var), 2)
            if color_r < 105:
                color_r = 105
            color_g = 255 - math.pow((300 - trail_var), 2)
            if color_g < 105:
                color_g = 105
            color_b = math.pow((300 - trail_var), 2)
            if color_b > 105:
                color_b = 105
            pygame.draw.line(screen, (color_r, color_g, color_b), saved_pos_1, (part.rect.x, part.rect.y), (int(5 * (trail_var / 100)) - 6))
        saved_pos_1 = pygame.Vector2(part.rect.x, part.rect.y)
        Particle.Particle.move(part, 0, 0, True)

    #vapen samt rotation av vapnet
    if weapon_mode == "normal":
        weapon_color = (120, 120, 120)
    if weapon_mode == "blast":
        weapon_color = (200, 60, 60)
    pygame.draw.polygon(screen, weapon_color, ((player.player_pos_x() + 8 + 12 * math.sin(mouse_ang), player.player_pos_y() + 16 + 12 * math.cos(mouse_ang - math.pi / 12)),
                                                                (player.player_pos_x() + 8 - 12 * math.sin(mouse_ang + math.pi / 8), player.player_pos_y() + 16 - 12 * math.cos(mouse_ang + math.pi / 12)),
                                                                (player.player_pos_x() + 8 - 12 * math.sin(mouse_ang), player.player_pos_y() + 16 - 12 * math.cos(mouse_ang - math.pi / 12)),
                                                                (player.player_pos_x() + 8 + 12 * math.sin(mouse_ang + math.pi / 8), player.player_pos_y() + 16 + 12 * math.cos(mouse_ang + math.pi / 12))))

    #fortsättning av väggplacering
    for wall in Wall.walls:
        if wall.type == "wall":
            pygame.draw.rect(screen, wall.color, wall.rect)

    for wall in Wall.walls:
        if wall.type == "front_wall":
            pygame.draw.rect(screen, wall.color, wall.rect)

    for wall in Wall.walls:
        if wall.type == "solid_front_wall":
            pygame.draw.rect(screen, wall.color, wall.rect)

    if keys[pygame.K_SPACE]:
        for n in range(len(help_texts)):
            game_text.render_to(screen, (900, 100 + n * 25), help_texts[n], (255, 255, 255))

    if help_timer > 0:
        game_text.render_to(screen, (900, 100), "Open controls with spacebar", (255, 255, 255))
        help_timer -= 1
        if help_timer < 0:
            help_timer = 0


    #visa omladdning av shot
    if shot_timer >= 0:

        shot_1 = pygame.Rect(50, 50, shot_timer * 2, 20)
        cd_rect = pygame.draw.rect(screen, (255, 255, 255), shot_1)
        if shot_timer > 60:
            shot_2 = pygame.Rect(170, 50, shot_timer * 2 - 120, 20)
            pygame.draw.rect(screen, (255, 150, 150), shot_2)

    #visa hälsa
    if player.health < 0:
        player.health = 0
        dead = True
    if player.health > 100:
        player.health = 100
    if not player.player_health() <= 0:
        healthbar = pygame.Rect(player.player_pos_x() - 42, player.player_pos_y() - 32, player.player_health(), 10)
        pygame.draw.rect(screen, (255 - player.player_health(), 155 + player.player_health(), 150), healthbar)

    # hindrar spelaren från att byta vapen för snabbt
    switch_timer -= 1

    crouch_timer -= 1

    if dead:
        end_screen_death = pygame.Rect(300, 180, 700, 300)
        pygame.draw.rect(screen, (255, 255, 255), end_screen_death)
        game_text.render_to(screen, (600, 300), "Dead", (0, 0, 0))

    pygame.display.flip()

    #fps samt tickspeed
    dt = clock.tick(60) / 1000

    #omstart vid död
    if dead:
        time.sleep(3)
        dead = False
        player.health = 100
        rx = 2
        ry = 4
        load_room(2, 4)
        Particle.particles = []
        Particle.part_trail = []
        Particle.enemy_bul = []
        Enemy.enemies = []
        player.rect.x = 800
        player.rect.y = 400



pygame.quit()